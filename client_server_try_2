
//lcd Ywrobot Arduino lcm1602 iic v1
//Connect GND, VCC, SDA and SCL from lcd to corresponding pins on arduino (only these pins need to be connected)
//temp sensor: lm35
//facing flat side of temp sensor: left to +5, middle to analog input(A0 to A5), right pin to GND

//curl -X POST -H "Content-Type:application/json" -d @sample.json http://192.168.1.34

//POST / HTTP/1.1
//User-Agent: curl/7.37.1
//Host: 192.168.1.34
//Accept: */*
//Content-Type:application/json
//Content-Length: 70
//{  "message": "Let's see if this works.",  "subject": "JSON via curl"}

#include <EthernetV2_0.h>
#include <SPI.h>
#include "Time.h"
#include <Wire.h>
#include <LiquidCrystal_I2C.h> // download library if not available
#include <stdio.h>
#include <stdlib.h>

#define SDCARD_CS 4
//#define ledPin 13


struct report_record
{
    String uuid;
    String ReportResource;
    String *ReportDeliveryLocations;
    String user_agent;
    int MinPeriod;
    int MaxPeriod;
    int ExpireTime;
    int del_num;
    float temp_record;
};


struct report_record record[5]; //storing more records hangs

char report[400];
int ch=0;

LiquidCrystal_I2C lcd(0x27, 2, 1, 0, 4, 5, 6, 7, 3, POSITIVE);  // Set the LCD I2C address
time_t tm;
char timechar[10];

int nr; //number of records

//conection related stuff
byte mac[] = { 0x00, 0xAA, 0xBB, 0xCC, 0xDE, 0x02 };
byte ip[]      = { 192, 168,   1,  199 };
byte gateway[] = { 192, 168,   1,  1 };
byte subnet[]  = { 255, 255, 255,   0 };
IPAddress server_ip(192,168,1,33);
IPAddress ip_temp;
int connect_ret;
EthernetClient client;
EthernetServer server(80); //telnet defaults to this port


void setup()  
{
  
    Serial.begin(9600);  // Used to type in characters
    delay(1000);
    Serial.println("Setup");
    //deselect SD card
    pinMode(SDCARD_CS,OUTPUT);
    digitalWrite(SDCARD_CS,HIGH);//Deselect the SD card
    
    lcd.begin(16,2);   // initialize the lcd for 16 chars 2 lines, turn on backlight
    lcd.clear();
   
    
    if(Ethernet.begin(mac)==0)
    {
        Serial.println("Unable to assign IP using DHCP");
        Ethernet.begin(mac, ip, gateway, subnet);
        
    }
    
    server.begin();
        
        
        //Serial.print("My IP address: ");
        Serial.print("Arduino's IP:");
        ip_temp = Ethernet.localIP();
        for (byte thisByte = 0; thisByte < 4; thisByte++)
        {
            // print the value of each byte of the IP address:
            Serial.print(ip_temp[thisByte], DEC);
            Serial.print(".");
        }
        
        Serial.println();
}

void parse_header()
{
  char *next_token;
  char **rem;
  
  Serial.println("Inside parse header");
  for(next_token = strtok(report, ":\r\n"); next_token!=NULL; next_token=strtok(NULL, ":\r\n"))
  {
  
     //Serial.println("Finished strtok");
    
    //Print token parsed
    
     Serial.print("Token parsed:");
     Serial.println(next_token);
     
     
    // String str = String(next_token);
     
   /* if((strcmp(next_token,"User-Agent"))==0)
     {
       Serial.println("Finally found user agent");
      
     //  record[nr].user_agent=String(strtok(NULL,"\r\n"));
     //  Serial.println(record[nr].user_agent);
     }
 */
  }
  
}
void disp_time()
{
    tm=now();
    dtostrf(tm,4,0,timechar);
 
     
    Serial.print("TIME = ");
    Serial.println(tm);
   
    lcd.clear();
    lcd.setCursor(0,0);
    lcd.write("Time:");
    lcd.setCursor(7,0);
    lcd.write(timechar);
}

void send_data()
{
  
                Serial.println("Sending time data...");
                client.println("PUT / HTTP/1.0");
                client.println("Content-Type: application/json");
                client.println("Connection: Keep-Alive");
                client.println("Content-Length: 20");
                client.println();
                client.print("\"Time\":");
                client.println(timechar);
                client.println();
                Serial.println("Time sent through telnet");
                
}
/*

int conn()
{
    Serial.println("Conn");
    connect_ret=client.connect(server_ip,8080);
    Serial.print("Return from connect:");
    Serial.println(connect_ret);
    return connect_ret;
}
*/
void loop()
{
  disp_time();
  
  //Serial.println("Loop");
  
  
    client=server.available(); // listen for incoming clients
    
    if(client)
    {
    
        Serial.println("New client");
      
            while(client.available())
            {
              
                char c=client.read();
                Serial.write(c);
                report[ch]=c;
                report[ch+1]='\0';
                ch++;
                
                 
            } // client.available()
            Serial.println();
            ch=0;
    //prints the content stored in report
   /* 
     for(int i=0;i< ch;i++)
     {
       Serial.write(report[i]);
     }
     
     Serial.println();
     */ 
     
     if(strstr(report, "POST")!=NULL)
     {
       Serial.println("Parsing Header...");
       parse_header();
       
     }
    
    
     else
     {
       Serial.println("Not POST");
       
     }//Is a POST Request
       
       
    }//if(client)
    // client.stop();
        //Serial.println("Client disconnected");
        
        delay(1000);
   // conn(); //send data 
   
    
} // end of loop1
